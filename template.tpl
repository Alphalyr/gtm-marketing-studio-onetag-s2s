___INFO___

{
  "type": "TAG",
  "categories": [
    "REMARKETING",
    "ANALYTICS",
    "ADVERTISING",
    "ATTRIBUTION",
    "CONVERSIONS",
    "TAG_MANAGEMENT",
    "AFFILIATE_MARKETING"
  ],
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Alphalyr Marketing Studio S2S",
  "brand": {
    "id": "github.com_Alphalyr",
    "displayName": "Alphalyr",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKQAAACVCAMAAADhTaF7AAAAM1BMVEWRWYu1kLHayNh1MG728fXIrMWjdZ5+Pnft4+zj1eKITIGaZ5XRus6tg6i+nrtsImT///8sTjt0AAAAEXRSTlP/////////////////////ACWtmWIAAAAJcEhZcwAACxMAAAsTAQCanBgAAAW4aVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA3LjEtYzAwMCA3OS5lZGEyYjNmYWMsIDIwMjEvMTEvMTctMTc6MjM6MTkgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bWxuczpwaG90b3Nob3A9Imh0dHA6Ly9ucy5hZG9iZS5jb20vcGhvdG9zaG9wLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCAyMy4xIChNYWNpbnRvc2gpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAyMi0xMS0yMVQxMzo0ODowN1oiIHhtcDpNb2RpZnlEYXRlPSIyMDIyLTExLTIxVDEzOjUwOjE3WiIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMi0xMS0yMVQxMzo1MDoxN1oiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIyIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI0YzE2ZDc0LWQyZDctNDdlNy1iYWZmLWEyZmNhYzNmNzkyYSIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOmFiY2Y5NDI2LWI3MTItOTI0NC1hNTExLTM2YThmMzg3MDZiOCIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjBmNGYyZWY4LWZhNDUtNDlhYi04NjhhLThlYzBkZWViZDE3NyI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MGY0ZjJlZjgtZmE0NS00OWFiLTg2OGEtOGVjMGRlZWJkMTc3IiBzdEV2dDp3aGVuPSIyMDIyLTExLTIxVDEzOjQ4OjA3WiIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIDIzLjEgKE1hY2ludG9zaCkiLz4gPHJkZjpsaSBzdEV2dDphY3Rpb249InNhdmVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjI0YzE2ZDc0LWQyZDctNDdlNy1iYWZmLWEyZmNhYzNmNzkyYSIgc3RFdnQ6d2hlbj0iMjAyMi0xMS0yMVQxMzo1MDoxN1oiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCAyMy4xIChNYWNpbnRvc2gpIiBzdEV2dDpjaGFuZ2VkPSIvIi8+IDwvcmRmOlNlcT4gPC94bXBNTTpIaXN0b3J5PiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pt+akxIAAAZ4SURBVHja7ZzZlqwqDIbDICIq8P5Puy+qz+5SGfIDWrXXOrntLv0MmQgDxX9AaOTD5Jt8HaSVwtAcTjKTEdJ+BaQUpEJB1CrkRyGtXwNLVm8/A2m9C4C4Ds5WyIkCLDQ9CWl3FZpECfsQpDWhQ4x9ALIPsQ2TnkYMIQSj74QUKgwRJW6DlHMYJrO8BVKbMFR2PR5ypBpRZXIh93CDiKGQ1oVbhPQ4SKnCTaKWUZBT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\u003d"
  },
  "description": "Implementation of tracking code for Alphalyr Marketing Studio\n@author Sylvestre Ho\n@web https://alphalyr.com\n@version 2023-06-02",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "InitOptions",
    "displayName": "Init Options",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "customerId",
        "displayName": "Client public key",
        "simpleValueType": true,
        "help": "Unique public key given to you by Alphalyr Marketing Studio.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "alwaysInSummary": true
      },
      {
        "type": "TEXT",
        "name": "userEmail",
        "displayName": "User Email Hash",
        "simpleValueType": true,
        "help": "Hash MD5 de l’adresse email du client lorsqu’il est identifié. Laisser le paramètre vide si le client n’est pas identifié."
      },
      {
        "type": "TEXT",
        "name": "confirmationCustomerType",
        "displayName": "Customer Type",
        "simpleValueType": true,
        "enablingConditions": [],
        "help": "Match to \"new\" in technical documentation.\nTakes the value \"0\" when it is an old client and \"1\" when it is a new client."
      },
      {
        "type": "TEXT",
        "name": "customData",
        "displayName": "Custom Data",
        "simpleValueType": true,
        "help": "Additional data that can be added for custom data processing."
      },
      {
        "type": "CHECKBOX",
        "name": "isSPA",
        "checkboxText": "Is SPA",
        "simpleValueType": true,
        "help": "Whether your website is a Single Page App."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "GDPRConfigurations",
    "displayName": "GDPR Consent options",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "gdprConsent",
        "displayName": "GDPR Consent",
        "simpleValueType": true,
        "help": "Takes the value 1 if the user has consented to the use of his data for analytics purposes. Marketing Studio will store data accordingly in order to comply with GDPR policies."
      },
      {
        "type": "TEXT",
        "name": "consentAds",
        "displayName": "Consent statut for Ads \u0026 Marketing",
        "simpleValueType": true,
        "help": "Takes the value 1 if the user has consented to the use of his data for targeting and marketing. This parameter is transmitted to partners."
      },
      {
        "type": "TEXT",
        "name": "consentPerformance",
        "displayName": "Consent statut for Performance",
        "simpleValueType": true,
        "help": "Takes the value 1 if the user has consented to the use of his data for the measurement of performance measurement. This parameter is transmitted to partners."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const encodeUriComponent = require('encodeUriComponent');
const sendHttpRequest = require('sendHttpRequest');
const getAllEventData = require('getAllEventData');
const parseUrl = require('parseUrl');
const sha256Sync = require('sha256Sync');
const getTimestamp = require('getTimestamp');
const Math = require('Math');

const onSuccess = () => {
  data.gtmOnSuccess();
};

const onFailure = () => {
  data.gtmOnFailure();
};

const pageMap = {
  view_item: 'product',
  view_item_list: 'category',
  view_cart: 'cart',
  purchase: 'purchase',
};

function serverToServerCall(url, onSuccess, onFailure) {
  const requestHeaders = { method: 'GET' };
  sendHttpRequest(url, (statusCode, headers, body) => {
    if (statusCode >= 200 && statusCode < 300) {
      onSuccess();
    } else {
      onFailure();
    }
  }, requestHeaders, '');
}

const parseDiscount = (d) => {
  let totalDiscount = 0;

  if (typeof(d.discount) != 'undefined') {
    return d.discount;
  }

  d.items.forEach(item => {
    if (item.hasOwnProperty('discount'))
      totalDiscount += item.discount;
  });
  
  return totalDiscount;
};

const parseItems = (items) => {
  var parsedItems = '';
  items.forEach(item => {
    parsedItems += item.item_id + ':';
    parsedItems += item.quantity + ':';
    parsedItems += item.price + ';';
  });
  
  return parsedItems;
};

function getData(key) {
  let d = data;
    
  if (typeof(d[key]) != 'undefined') {
    return d[key];
  }
  
  d = getAllEventData();
  if (typeof(d[key]) != 'undefined') {
    return d[key];
  }
  
  let tax = d.tax || 0;

  if (key == 'confirmationTotalPricewithout') {
    return d.value;
  }
  
  if (key == 'confirmationTotalPricewith') {
    return (d.value + tax);
  }
  
  if (key == 'confirmationDiscountAmount' && typeof(d.items) != 'undefined') {
    return parseDiscount(d);
  }
  
  if (key == 'productTable' && typeof(d.items) != 'undefined') {
    return parseItems(d.items);
  }
  
  return data[key];
}


const TEMPLATE_VERSION = '1.0.1';
const MARKETINGSTUDIO_LIBRARY_URL = 'https://tck.elitrack.com/';

let finalConstructor = '';

// -------- PATH CONSTRUCTOR --------
let track = 'tag/store';
if (getData('event_name') == 'purchase') {
    track = 'track/store';
}

let pathConstructor = track;

// -------- GENERIC DATA --------
let allData = getAllEventData();
let deviceType = (allData.client_hints && allData.client_hints.mobile) ? 'm' : 'd';
let page = pageMap[getData('event_name')] || 'home';
let aid = getData('customerId') || '';
let cid = getData('userEmail') || '';
let customData = getData('customData') || '';
let gaSessionId = getData('ga_session_id') || '';
let gaSessionDuration = 0;
let genericConstructor = '?page=' + page + '&aid=' + aid + '&cid=' + cid;
let ipOverride = getData('ip_override');
let bytes = ipOverride.split('.');
bytes[3] = '0';
ipOverride = bytes.join('.');

let referrerUrl = getData('page_referrer');
let referrer = '';
if (referrerUrl) {
    referrerUrl = parseUrl(referrerUrl);
    referrer = referrerUrl.origin;
}


let clientIdCustom = ipOverride + ';' + aid + ';' + getData('user_agent');
genericConstructor += '&uuid=' + sha256Sync(clientIdCustom, {outputEncoding: 'hex'});
genericConstructor += '&referrer=' + encodeUriComponent(referrer);
genericConstructor += '&ip_address=' + ipOverride;
genericConstructor += '&user_agent=' + encodeUriComponent(getData('user_agent'));
genericConstructor += '&deviceType=' + deviceType;

if (getData('isSPA')) {
  gaSessionDuration = Math.floor((getTimestamp() - (gaSessionId * 1000)) / 1000);
  genericConstructor += '&gaSessionId=' + gaSessionId;
  genericConstructor += '&gaSessionDuration=' + gaSessionDuration;
}

let pageLocation = getData('page_location') || '';
const parsedUrl = parseUrl(pageLocation);
const params = {};
if (parsedUrl && parsedUrl.searchParams) {
  for (let param in parsedUrl.searchParams) {
    genericConstructor += '&' + param + '=' + encodeUriComponent(parsedUrl.searchParams[param].split(',')[0]);
  }
  genericConstructor += '&path=' + parsedUrl.pathname;
}


let consentConstructor = '?aid=' + aid;


// -------- PRODUCT PAGE DATA --------
let items = getData('items') || [];
let item = {};
if (typeof(items[0]) != 'undefined') {
  item = items[0];
}
let prodId = item.item_id || '';
let prodDescription = item.item_name || '';
let prodPrice = getData('value') || '';
let productPageConstructor = '&prodId=' + prodId + '&prodDescription=' + prodDescription + '&prodPrice=' + prodPrice;


// -------- PRODUCT ARRAY DATA --------
let products = getData('productTable') || '';
let currency = getData('currency') || '';


// -------- CATEGORY PAGE DATA --------
let catId = getData('item_list_id') || '';
let catDescription = getData('item_list_name') || '';
let categoryPageConstructor = '&catId=' + catId + '&catDescription=' + catDescription;

// -------- CART PAGE DATA --------
let cartTotalPrice = getData('value') || '';
let cartPageConstructor = '&products=' + products + '&totalPrice=' + cartTotalPrice + '&currency=' + currency;


// -------- TRANSACTION DATA --------
let referenceTransaction = getData('transaction_id') || '';
let transactionTotalPrice = getData('confirmationTotalPricewithout') || '';
let totalPriceWithTax = getData('confirmationTotalPricewith') || '';
let shippingPrice = getData('shipping') || '';
let clientType = getData('confirmationCustomerType') || '';
let discountCode = getData('coupon') || '';
let discountAmount = getData('confirmationDiscountAmount') || '';

let transactionPageConstructor = '&products=' + products + '&totalPrice=' + transactionTotalPrice + '&totalPriceWithTax=' + totalPriceWithTax + '&shippingPrice=' + shippingPrice + '&reference=' + referenceTransaction + '&new=' + clientType + '&currency=' + currency + '&discountCode=' + discountCode + '&discountAmount=' + discountAmount + '&customData=' + customData;


// -------- GDPR Consent Constructor DATA --------
let gdpr_consent = getData('gdprConsent') ||'';
if (gdpr_consent == null || gdpr_consent == '' || gdpr_consent == undefined) {
  gdpr_consent = 0;
}
let consent_ads = getData('consentAds') || '';
if (consent_ads == null || consent_ads == '' ||  consent_ads == undefined) {
  consent_ads = 0;
}
let consent_performance = getData('consentPerformance') || '';
if (consent_performance == null || consent_performance == '' || consent_performance == undefined) {
  consent_performance = 0;
}
let gdprConstructor = '&gdpr_consent=' + gdpr_consent + '&consent_ads=' + consent_ads + '&consent_performance=' + consent_performance;

// -------- TRACKER CONSTRUCTOR --------
switch (page) {
    case 'home':
        finalConstructor = pathConstructor + genericConstructor + gdprConstructor;
    break;
    case 'category':
        finalConstructor = pathConstructor + genericConstructor + categoryPageConstructor + gdprConstructor;
    break;
    case 'product':
        finalConstructor = pathConstructor + genericConstructor + productPageConstructor + gdprConstructor;
    break;
    case 'cart':
        finalConstructor = pathConstructor + genericConstructor + cartPageConstructor + gdprConstructor;
    break;
    case 'purchase':
        finalConstructor = pathConstructor + genericConstructor + transactionPageConstructor + gdprConstructor;
    break;
    default: finalConstructor = pathConstructor + genericConstructor + gdprConstructor;

}


let elitrackendpoint = MARKETINGSTUDIO_LIBRARY_URL + finalConstructor;

serverToServerCall(elitrackendpoint, onSuccess, onFailure);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://tck.elitrack.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 21.11.2022 14:33:16


